## å¹¶å‘æ§åˆ¶(Concurrency control)-äº’æ–¥

### å…±äº«å†…å­˜ä¸Šçš„äº’æ–¥

å®ç°äº’æ–¥çš„æ ¹æœ¬å›°éš¾ï¼šä¸èƒ½åŒæ—¶è¯»/å†™å…±äº«å†…å­˜

- load (ç¯é¡¾å››å‘¨) çš„æ—¶å€™ä¸èƒ½å†™ï¼Œåªèƒ½ â€œçœ‹ä¸€çœ¼å°±æŠŠçœ¼ç›é—­ä¸Šâ€
  çœ‹åˆ°çš„ä¸œè¥¿é©¬ä¸Šå°±è¿‡æ—¶äº†
- store (æ”¹å˜ç‰©ç†ä¸–ç•ŒçŠ¶æ€) çš„æ—¶å€™ä¸èƒ½è¯»ï¼Œåªèƒ½ â€œé—­ç€çœ¼ç›åŠ¨æ‰‹â€
  ä¹Ÿä¸çŸ¥é“æŠŠä»€ä¹ˆæ”¹æˆäº†ä»€ä¹ˆ
- è¿™æ˜¯ç®€å•ã€ç²—æš´ (ç¨³å®š)ã€æœ‰æ•ˆçš„ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾

### è‡ªæ—‹é”(Spin Lock)

å‡è®¾ç¡¬ä»¶èƒ½ä¸ºæˆ‘ä»¬æä¾›ä¸€æ¡ â€œç¬é—´å®Œæˆâ€ çš„è¯» + å†™æŒ‡ä»¤

- è¯·æ‰€æœ‰äººé—­ä¸Šçœ¼ç›ï¼Œçœ‹ä¸€çœ¼ (load)ï¼Œç„¶åè´´ä¸Šæ ‡ç­¾ (store)

  - å¦‚æœå¤šäººåŒæ—¶è¯·æ±‚ï¼Œç¡¬ä»¶é€‰å‡ºä¸€ä¸ª â€œèƒœè€…â€
  - â€œè´¥è€…â€ è¦ç­‰ â€œèƒœè€…â€ å®Œæˆåæ‰èƒ½ç»§ç»­æ‰§è¡Œ

#### x86 åŸå­æ“ä½œï¼šLOCK æŒ‡ä»¤å‰ç¼€

ä¾‹å­ï¼šsum-atomic.c

    sum = 200000000

Atomic exchange (load + store)

        int xchg(volatile int *addr, int newval) {
          int result;
          asm volatile ("lock xchg %0, %1"
            : "+m"(*addr), "=a"(result) : "1"(newval));
          return result;
        }

#### ç”¨ xchg å®ç°äº’æ–¥

å¦‚ä½•åè°ƒå®¿èˆè‹¥å¹²ä½åŒå­¦ä¸Šå•æ‰€é—®é¢˜ï¼Ÿ

    åœ¨å•æ‰€é—¨å£æ”¾ä¸€ä¸ªæ¡Œå­ (å…±äº«å˜é‡)
    åˆå§‹æ—¶ï¼Œæ¡Œä¸Šæ˜¯ ğŸ”‘
    å®ç°äº’æ–¥çš„åè®®

    æƒ³ä¸Šå•æ‰€çš„åŒå­¦ (ä¸€æ¡ xchg æŒ‡ä»¤)
    å¤©é»‘è¯·é—­çœ¼
    çœ‹ä¸€çœ¼æ¡Œå­ä¸Šæœ‰ä»€ä¹ˆ (ğŸ”‘ æˆ– ğŸ”)
    æŠŠ ğŸ” æ”¾åˆ°æ¡Œä¸Š (è¦†ç›–ä¹‹å‰æœ‰çš„ä»»ä½•ä¸œè¥¿)
    å¤©äº®è¯·ççœ¼ï¼›çœ‹åˆ° ğŸ”‘ æ‰å¯ä»¥è¿›å•æ‰€å“¦
    å‡ºå•æ‰€çš„åŒå­¦
    æŠŠ ğŸ”‘ æ”¾åˆ°æ¡Œä¸Š

#### å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”

    int table = YES;

    void lock() {
    retry:
      int got = xchg(&table, NOPE);
      if (got == NOPE)
        goto retry;
      assert(got == YES);
    }

    void unlock() {
      xchg(&table, YES)
    }
    int locked = 0;
    void lock() { while (xchg(&locked, 1)) ; }
    void unlock() { xchg(&locked, 0); }

å¹¶å‘ç¼–ç¨‹ï¼šåƒä¸‡å°å¿ƒ

- åšè¯¦å°½çš„æµ‹è¯• (åœ¨æ­¤çœç•¥ï¼Œä½ ä»¬åš Labs å°±çŸ¥é“äº†)
- å°½å¯èƒ½åœ°è¯æ˜ (model-checker.py å’Œ spinlock.py)

åŸå­æŒ‡ä»¤çš„æ¨¡å‹

- ä¿è¯ä¹‹å‰çš„ store éƒ½å†™å…¥å†…å­˜
- ä¿è¯ load/store ä¸ä¸åŸå­æŒ‡ä»¤ä¹±åº

#### åŸå­æŒ‡ä»¤çš„è¯ç”Ÿï¼šBus Lock (80486)

486 (20-50MHz) å°±æ”¯æŒ dual-socket äº†

#### Lock æŒ‡ä»¤çš„ç°ä»£å®ç°

åœ¨ L1 cache å±‚ä¿æŒä¸€è‡´æ€§ (ring/mesh bus)

- ç›¸å½“äºæ¯ä¸ª cache line æœ‰åˆ†åˆ«çš„é”
- store(x) è¿›å…¥ L1 ç¼“å­˜å³ä¿è¯å¯¹å…¶ä»–å¤„ç†å™¨å¯è§
  - ä½†è¦å°å¿ƒ store buffer å’Œä¹±åºæ‰§è¡Œ

L1 cache line æ ¹æ®çŠ¶æ€è¿›è¡Œåè°ƒ

- M (Modified), è„å€¼
- E (Exclusive), ç‹¬å è®¿é—®
- S (Shared), åªè¯»å…±äº«
- I (Invalid), ä¸æ‹¥æœ‰ cache line

#### RISC-V: å¦ä¸€ç§åŸå­æ“ä½œçš„è®¾è®¡

è€ƒè™‘å¸¸è§çš„åŸå­æ“ä½œï¼š

- atomic test-and-set
- reg = load(x); if (reg == XX) { store(x, YY); }
- lock xchg
- reg = load(x); store(x, XX);
- lock add
- t = load(x); t++; store(x, t);

å®ƒä»¬çš„æœ¬è´¨éƒ½æ˜¯ï¼š

- load
- exec (å¤„ç†å™¨æœ¬åœ°å¯„å­˜å™¨çš„è¿ç®—)
- store

#### Load-Reserved/Store-Conditional (LR/SC)

LR: åœ¨å†…å­˜ä¸Šæ ‡è®° reserved (ç›¯ä¸Šä½ äº†)ï¼Œä¸­æ–­ã€å…¶ä»–å¤„ç†å™¨å†™å…¥éƒ½ä¼šå¯¼è‡´æ ‡è®°æ¶ˆé™¤

    lr.w rd, (rs1)
      rd = M[rs1]
      reserve M[rs1]

SC: å¦‚æœ â€œç›¯ä¸Šâ€ æœªè¢«è§£é™¤ï¼Œåˆ™å†™å…¥

    sc.w rd, rs2, (rs1)
      if still reserved:
        M[rs1] = rs2
        rd = 0
      else:
        rd = nonzero

#### Compare-and-Swap çš„ LR/SC å®ç°

    int cas(int *addr, int cmp_val, int new_val) {
      int old_val = *addr;
      if (old_val == cmp_val) {
        *addr = new_val; return 0;
      } else { return 1; }
    }

    cas:
      lr.w  t0, (a0)       # Load original value.
      bne   t0, a1, fail   # Doesnâ€™t match, so fail.
      sc.w  t0, a2, (a0)   # Try to update.
      bnez  t0, cas        # Retry if store-conditional failed.
      li a0, 0             # Set return to success.
      jr ra                # Return.
    fail:
      li a0, 1             # Set return to failure.
      jr ra                # Return

#### LR/SC çš„ç¡¬ä»¶å®ç°

BOOM (Berkeley Out-of-Order Processor)

- riscv-boom
  - lsu/dcache.scala
  - ç•™æ„ s2_sc_fail çš„æ¡ä»¶
    - s2 æ˜¯æµæ°´çº¿ Stage 2
  - (yzh æ‰’å‡ºçš„ä»£ç )

#### è‡ªæ—‹é”çš„ç¼ºé™·

æ€§èƒ½é—®é¢˜ (0)

- è‡ªæ—‹ (å…±äº«å˜é‡) ä¼šè§¦å‘å¤„ç†å™¨é—´çš„ç¼“å­˜åŒæ­¥ï¼Œå»¶è¿Ÿå¢åŠ 

æ€§èƒ½é—®é¢˜ (1)

- é™¤äº†è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ï¼Œå…¶ä»–å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹éƒ½åœ¨ç©ºè½¬
- äº‰æŠ¢é”çš„å¤„ç†å™¨è¶Šå¤šï¼Œåˆ©ç”¨ç‡è¶Šä½

æ€§èƒ½é—®é¢˜ (2)

- è·å¾—è‡ªæ—‹é”çš„çº¿ç¨‹å¯èƒ½è¢«æ“ä½œç³»ç»Ÿåˆ‡æ¢å‡ºå»
  - æ“ä½œç³»ç»Ÿä¸ â€œæ„ŸçŸ¥â€ çº¿ç¨‹åœ¨åšä»€ä¹ˆ
  - (ä½†ä¸ºä»€ä¹ˆä¸èƒ½å‘¢ï¼Ÿ)
- å®ç° 100% çš„èµ„æºæµªè´¹

#### Scalability: æ€§èƒ½çš„æ–°ç»´åº¦

åŒä¸€ä»½è®¡ç®—ä»»åŠ¡ï¼Œæ—¶é—´ (CPU cycles) å’Œç©ºé—´ (mapped memory) ä¼šéšå¤„ç†å™¨æ•°é‡çš„å¢é•¿è€Œå˜åŒ–ã€‚

- sum-scalability.c
- thread-sync.h
  - ä¸¥è°¨çš„ç»Ÿè®¡å¾ˆéš¾
    - CPU åŠ¨æ€åŠŸè€—
    - ç³»ç»Ÿä¸­çš„å…¶ä»–è¿›ç¨‹
    - â€¦â€¦
  - Benchmarking crimes

#### è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯

1. ä¸´ç•ŒåŒºå‡ ä¹ä¸ â€œæ‹¥å µâ€
2. æŒæœ‰è‡ªæ—‹é”æ—¶ç¦æ­¢æ‰§è¡Œæµåˆ‡æ¢

ä½¿ç”¨åœºæ™¯ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„ (çŸ­ä¸´ç•ŒåŒº)

- æ“ä½œç³»ç»Ÿå¯ä»¥å…³é—­ä¸­æ–­å’ŒæŠ¢å 
  - ä¿è¯é”çš„æŒæœ‰è€…åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å¯ä»¥é‡Šæ”¾é”
- (å¦‚æœæ˜¯è™šæ‹Ÿæœºå‘¢...ğŸ˜‚)
  - PAUSE æŒ‡ä»¤ä¼šè§¦å‘ VM Exit
- ä½†ä¾æ—§å¾ˆéš¾åšå¥½
  - An analysis of Linux scalability to many cores (OSDI'10)

### äº’æ–¥é”(Mutex Lock)

#### å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥

> ä½œä¸šé‚£ä¹ˆå¤šï¼Œä¸å…¶å¹²ç­‰ Online Judge å‘å¸ƒï¼Œä¸å¦‚æŠŠè‡ªå·± (CPU) è®©ç»™å…¶ä»–ä½œä¸š (çº¿ç¨‹) æ‰§è¡Œï¼Ÿ

â€œè®©â€ ä¸æ˜¯ C è¯­è¨€ä»£ç å¯ä»¥åšåˆ°çš„ (C ä»£ç åªèƒ½è®¡ç®—)

- æŠŠé”çš„å®ç°æ”¾åˆ°æ“ä½œç³»ç»Ÿé‡Œå°±å¥½å•¦ï¼
  - syscall(SYSCALL_lock, &lk);
    - è¯•å›¾è·å¾— lkï¼Œä½†å¦‚æœå¤±è´¥ï¼Œå°±åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹
  - syscall(SYSCALL_unlock, &lk);
    - é‡Šæ”¾ lkï¼Œå¦‚æœæœ‰ç­‰å¾…é”çš„çº¿ç¨‹å°±å”¤é†’

#### å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥ (cont'd)

æ“ä½œç³»ç»Ÿ = æ›´è¡£å®¤ç®¡ç†å‘˜

- å…ˆåˆ°çš„äºº (çº¿ç¨‹)
  - æˆåŠŸè·å¾—æ‰‹ç¯ï¼Œè¿›å…¥æ¸¸æ³³é¦†
  - \*lk = ğŸ”’ï¼Œç³»ç»Ÿè°ƒç”¨ç›´æ¥è¿”å›
- ååˆ°çš„äºº (çº¿ç¨‹)
  - ä¸èƒ½è¿›å…¥æ¸¸æ³³é¦†ï¼Œæ’é˜Ÿç­‰å¾…
  - çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæ‰§è¡Œçº¿ç¨‹åˆ‡æ¢ (yield)
- æ´—å®Œæ¾¡å‡ºæ¥çš„äºº (çº¿ç¨‹)
  - äº¤è¿˜æ‰‹ç¯ç»™ç®¡ç†å‘˜ï¼›ç®¡ç†å‘˜æŠŠæ‰‹ç¯å†äº¤ç»™æ’é˜Ÿçš„äºº
  - å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ
  - å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œ\*lk = âœ…
- ç®¡ç†å‘˜ (OS) ä½¿ç”¨è‡ªæ—‹é”ç¡®ä¿è‡ªå·±å¤„ç†æ‰‹ç¯çš„è¿‡ç¨‹æ˜¯åŸå­çš„

### Futex = Spin + Mutex

#### å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ

è‡ªæ—‹é” (çº¿ç¨‹ç›´æ¥å…±äº« locked)

- æ›´å¿«çš„ fast path
  - xchg æˆåŠŸ â†’ ç«‹å³è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¼€é”€å¾ˆå°
- æ›´æ…¢çš„ slow path
  - xchg å¤±è´¥ â†’ æµªè´¹ CPU è‡ªæ—‹ç­‰å¾…

ç¡çœ é” (é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—® locked)

- æ›´å¿«çš„ slow path
  - ä¸Šé”å¤±è´¥çº¿ç¨‹ä¸å†å ç”¨ CPU
- æ›´æ…¢çš„ fast path
  - å³ä¾¿ä¸Šé”æˆåŠŸä¹Ÿéœ€è¦è¿›å‡ºå†…æ ¸ (syscall)

#### Futex: Fast Userspace muTexes

> å°å­©å­æ‰åšé€‰æ‹©ã€‚æˆ‘å½“ç„¶æ˜¯å…¨éƒ½è¦å•¦ï¼

- Fast path: ä¸€æ¡åŸå­æŒ‡ä»¤ï¼Œä¸Šé”æˆåŠŸç«‹å³è¿”å›
- Slow path: ä¸Šé”å¤±è´¥ï¼Œæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ç¡çœ 
  - æ€§èƒ½ä¼˜åŒ–çš„æœ€å¸¸è§æŠ€å·§
    - çœ‹ average (frequent) case è€Œä¸æ˜¯ worst case

POSIX çº¿ç¨‹åº“ä¸­çš„äº’æ–¥é” (pthread_mutex)

- sum-scalability.cï¼Œæ¢æˆ mutex
  - è§‚å¯Ÿç³»ç»Ÿè°ƒç”¨ (strace)
  - gdb è°ƒè¯•
    - set scheduler-locking on, info threads, thread X

#### Futex: Fast Userspace muTexes (cont'd)

å…ˆåœ¨ç”¨æˆ·ç©ºé—´è‡ªæ—‹

- å¦‚æœè·å¾—é”ï¼Œç›´æ¥è¿›å…¥
- æœªèƒ½è·å¾—é”ï¼Œç³»ç»Ÿè°ƒç”¨
- è§£é”ä»¥åä¹Ÿéœ€è¦ç³»ç»Ÿè°ƒç”¨
  - futex.py
  - æ›´å¥½çš„è®¾è®¡å¯ä»¥åœ¨ fast-path ä¸è¿›è¡Œç³»ç»Ÿè°ƒç”¨

RTFM (åŠé€€)

- futex (7), futex (2)
- A futex overview and update (LWN)
- Futexes are tricky (è®º model checker çš„é‡è¦æ€§)
- (æˆ‘ä»¬ä¸è®²å¹¶å‘ç®—æ³•)

### æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- Q: å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šå®ç°äº’æ–¥ï¼Ÿ

Take-away message

- è½¯ä»¶ä¸å¤Ÿï¼Œç¡¬ä»¶æ¥å‡‘ (è‡ªæ—‹é”)
- ç”¨æˆ·ä¸å¤Ÿï¼Œå†…æ ¸æ¥å‡‘ (äº’æ–¥é”)
  - æ‰¾åˆ°ä½ ä¾èµ–çš„å‡è®¾ï¼Œå¹¶å¤§èƒ†åœ°æ‰“ç ´å®ƒ
- Fast/slow paths: æ€§èƒ½ä¼˜åŒ–çš„é‡è¦é€”å¾„
